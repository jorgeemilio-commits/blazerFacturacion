@page "/factura"
@rendermode InteractiveServer

@inject ServicioFactura ServicioFactura
@inject ControladorFactura ControladorFactura

<main class="container">
    
    <div class="border p-3 mb-4">
        <h3>Crear Nueva Factura</h3>
        
        <EditForm Model="ControladorFactura.FacturaEnProgreso" OnValidSubmit="GuardarFacturaAsync" FormName="FacturaForm">
            <DataAnnotationsValidator />
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Nombre del Cliente:</label>
                    <InputText class="form-control" @bind-Value="ControladorFactura.FacturaEnProgreso.NombreCliente" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Fecha de la Factura:</label>
                    <InputDate class="form-control" @bind-Value="ControladorFactura.FacturaEnProgreso.Fecha" />
                </div>
            </div>

            <hr />
            
            <h4>@(_modoEdicion ? "Editando Artículo" : "Agregar Artículos")</h4>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label>Nombre del Artículo:</label>
                    <InputText class="form-control" @bind-Value="_articuloTemporal.Nombre" />
                </div>
                <div class="col-md-2">
                    <label>Cantidad:</label>
                    <InputNumber class="form-control" @bind-Value="_articuloTemporal.Cantidad" />
                </div>
                <div class="col-md-3">
                    <label>Precio Unitario:</label>
                    <InputNumber class="form-control" @bind-Value="_articuloTemporal.PrecioUnitario" />
                </div>
                <div class="col-md-3 d-flex flex-column align-items-end justify-content-end">
                    @if (_modoEdicion)
                    {
                        <button type="button" class="btn btn-warning w-100" @onclick="ActualizarArticuloLocal">Actualizar</button>
                        <button type="button" class="btn btn-secondary w-100 mt-1" @onclick="CancelarEdicion">Cancelar</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-primary w-100" @onclick="AgregarArticuloLocal">Agregar</button>
                    }
                </div>
            </div>
            
            <ValidationSummary Model="_articuloTemporal" />
            @if (!string.IsNullOrEmpty(_mensajeErrorArticulo))
            {
            <p class="text-danger mt-2">@_mensajeErrorArticulo</p>
            }

            <hr />

            <h4>Artículos en la Nueva Factura</h4>
            @if (ControladorFactura.FacturaEnProgreso.Articulos.Any())
            {
            <table class="table table-sm table-striped table-bordered text-center align-middle">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
            @foreach (var art in ControladorFactura.FacturaEnProgreso.Articulos)
            {
                 <tr>
                    <td>@art.Nombre</td>
                    <td>@art.Cantidad</td>
                    <td>@art.PrecioUnitario.ToString("C")</td>
                    <td>@art.Total.ToString("C")</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-warning" @onclick="() => IniciarEdicionLocal(art)">🛠️</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => EliminarArticuloLocal(art)">🗑️</button>
                    </td>
                </tr>
            }
            </tbody>
            </table>
            <h4 class="text-end">Total: @ControladorFactura.FacturaEnProgreso.TotalCalculado.ToString("C")</h4>
            }

            else {
                <p>Aún no hay artículos agregados.</p>
            }
            
            <button type="submit" class="btn btn-success w-100 mt-3 fs-5">Guardar Factura Completa</button>
        </EditForm>
    </div>

</main>

@code {
    private ArticuloFactura _articuloTemporal = new ArticuloFactura();
    private ArticuloFactura _articuloParaEditar = null;
    private bool _modoEdicion = false;
    private string _mensajeErrorArticulo = string.Empty;


    // agregar artículo a la factura temporal
    private void AgregarArticuloLocal()
    {
        _mensajeErrorArticulo = string.Empty;
        if (string.IsNullOrWhiteSpace(_articuloTemporal.Nombre) || _articuloTemporal.Cantidad <= 0)
        {
            _mensajeErrorArticulo = "Nombre y Cantidad (mayor a 0) son requeridos.";
            return;
        }
        
        ControladorFactura.FacturaEnProgreso.Articulos.Add(_articuloTemporal);
        _articuloTemporal = new ArticuloFactura();
        _modoEdicion = false;
    }

    //edita artículo en la factura temporal
    private void IniciarEdicionLocal(ArticuloFactura art)
    {
        _articuloParaEditar = art;
        _articuloTemporal = new ArticuloFactura
        {
            ArticuloId = art.ArticuloId,
            Nombre = art.Nombre,
            Cantidad = art.Cantidad,
            PrecioUnitario = art.PrecioUnitario
        };
        _modoEdicion = true;
    }

    //actualiza artículo en la factura temporal
    private void ActualizarArticuloLocal()
    {
        _articuloParaEditar.Nombre = _articuloTemporal.Nombre;
        _articuloParaEditar.Cantidad = _articuloTemporal.Cantidad;
        _articuloParaEditar.PrecioUnitario = _articuloTemporal.PrecioUnitario;
        
        CancelarEdicion();
    }


    //elimina artículo en la factura temporal
    private void EliminarArticuloLocal(ArticuloFactura art)
    {
        if (art != null)
        {
            ControladorFactura.FacturaEnProgreso.Articulos.Remove(art);
        }
    }

    //cancela edición de artículo
    private void CancelarEdicion()
    {
        _articuloTemporal = new ArticuloFactura();
        _articuloParaEditar = null;
        _modoEdicion = false;
        _mensajeErrorArticulo = string.Empty;
    }

    //guardar factura completa
    private async Task GuardarFacturaAsync()
    {
        if (string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente))
        {
            _mensajeErrorArticulo = "El Nombre del Cliente es obligatorio para guardar la factura.";
            return;
        }
        
        await ServicioFactura.GuardarFacturaAsync(ControladorFactura.FacturaEnProgreso);
        
        ControladorFactura.FacturaEnProgreso = new Factura();
        _mensajeErrorArticulo = string.Empty;
    }
}
@page "/factura"
@rendermode InteractiveServer

@inject ServicioFactura ServicioFactura
@inject ServicioArticulo ServicioArticulo
@inject ControladorFactura ControladorFactura
@inject IJSRuntime JSRuntime

<main class="container py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold"><i class="bi bi-receipt"></i> Nueva Factura</h2>
        <span class="badge bg-secondary fs-6">@DateTime.Now.ToShortDateString()</span>
    </div>

    <EditForm Model="ControladorFactura.FacturaEnProgreso" OnValidSubmit="GuardarFacturaAsync" FormName="FacturaForm">
        <DataAnnotationsValidator />

        <div class="card shadow-sm mb-4 border-primary border-top border-4">
            <div class="card-body">
                <h5 class="card-title text-muted mb-3">Datos Generales</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Nombre del Cliente <span class="text-danger">*</span></label>
                        <InputText class="form-control form-control-lg" 
                                   @bind-Value="ControladorFactura.FacturaEnProgreso.NombreCliente" 
                                   placeholder="Escribe el nombre para desbloquear..." />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Fecha de Emisión</label>
                        <InputDate class="form-control form-control-lg" 
                                   @bind-Value="ControladorFactura.FacturaEnProgreso.Fecha" />
                    </div>
                </div>
            </div>
        </div>

        <fieldset disabled="@string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente)">
            <div class="card shadow-sm mb-4 @(string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente) ? "bg-light opacity-50" : "")">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="m-0 @(_modoEdicion ? "text-warning" : "text-success")">
                            @(_modoEdicion ? "✏️ Editando Artículo" : "🛒 Agregar Productos")
                        </h5>
                        @if (string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente))
                        {
                            <span class="badge bg-danger">Ingrese Cliente Primero</span>
                        }
                    </div>
                </div>
                <div class="card-body">
                    
                    @if (!_modoEdicion)
                    {
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i> Buscar</span>
                                <select class="form-select" @onchange="AlSeleccionarProducto">
                                    <option value="0">-- Seleccionar del Catálogo --</option>
                                    @foreach (var prod in _catalogoDisponibles)
                                    {
                                        <option value="@prod.Id">@prod.Nombre - @prod.Precio.ToString("C")</option>
                                    }
                                </select>
                            </div>
                        </div>
                    }

                    <div class="row g-2 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label small text-muted">Descripción</label>
                            <InputText class="form-control" @bind-Value="_articuloTemporal.Nombre" placeholder="Producto..." />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Cantidad</label>
                            <InputNumber class="form-control" @bind-Value="_articuloTemporal.Cantidad" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Precio Unit.</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <InputNumber class="form-control" @bind-Value="_articuloTemporal.PrecioUnitario" />
                            </div>
                        </div>
                        <div class="col-md-2">
                            @if (_modoEdicion)
                            {
                                <div class="d-grid gap-1">
                                    <button type="button" class="btn btn-warning btn-sm" @onclick="ActualizarArticuloLocal">Actualizar</button>
                                    <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelarEdicion">Cancelar</button>
                                </div>
                            }
                            else
                            {
                                <button type="button" class="btn btn-success w-100" @onclick="AgregarArticuloLocal">
                                    Agregar
                                </button>
                            }
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_mensajeErrorArticulo))
                    {
                        <div class="alert alert-danger mt-3 py-2 mb-0">
                            <small>@_mensajeErrorArticulo</small>
                        </div>
                    }
                </div>
            </div>
        </fieldset>

        @if (ControladorFactura.FacturaEnProgreso.Articulos.Any())
        {
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start ps-4">Descripción</th>
                                <th>Cant.</th>
                                <th>Precio</th>
                                <th>Subtotal</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var art in ControladorFactura.FacturaEnProgreso.Articulos)
                            {
                                <tr>
                                    <td class="text-start ps-4 fw-500">@art.Nombre</td>
                                    <td><span class="badge bg-light text-dark border">@art.Cantidad</span></td>
                                    <td>@art.PrecioUnitario.ToString("C")</td>
                                    <td class="fw-bold text-primary">@art.Total.ToString("C")</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-warning me-1 border-0" 
                                                @onclick="() => IniciarEdicionLocal(art)" title="Editar">
                                            ✏️
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger border-0" 
                                                @onclick="() => EliminarArticuloLocal(art)" title="Eliminar">
                                            🗑️
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end pe-3 fs-5">Total a Pagar:</td>
                                <td class="fs-4 fw-bold text-success">@ControladorFactura.FacturaEnProgreso.TotalCalculado.ToString("C")</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="mt-4 mb-5">
                <button type="submit" class="btn btn-primary btn-lg w-100 shadow">
                    💾 Guardar Factura
                </button>
            </div>
        }
        else 
        {
            @if (!string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente))
            {
                <div class="text-center py-5 text-muted border rounded border-dashed">
                    <p class="mb-0 fs-5">La factura está vacía.</p>
                    <small>Agrega artículos usando el panel de arriba.</small>
                </div>
            }
        }

    </EditForm>
</main>

@code {
    private ArticuloFactura _articuloTemporal = new ArticuloFactura();
    private ArticuloFactura _articuloParaEditar = null;
    private bool _modoEdicion = false;
    private string _mensajeErrorArticulo = string.Empty;
    
    private List<Articulo> _catalogoDisponibles = new List<Articulo>();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // Usamos ServicioArticulo para cargar el catálogo
            _catalogoDisponibles = await ServicioArticulo.GetCatalogoArticulosAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando catálogo: {ex.Message}");
        }
    }

    private void AlSeleccionarProducto(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int idSeleccionado) && idSeleccionado > 0)
        {
            var producto = _catalogoDisponibles.FirstOrDefault(p => p.Id == idSeleccionado);
            if (producto != null)
            {
                _articuloTemporal.Nombre = producto.Nombre;
                _articuloTemporal.PrecioUnitario = producto.Precio;
                _articuloTemporal.Cantidad = 1;
            }
        }
        else
        {
            _articuloTemporal.Nombre = string.Empty;
            _articuloTemporal.PrecioUnitario = 0;
        }
    }

    private void AgregarArticuloLocal()
    {
        _mensajeErrorArticulo = string.Empty;
        
        // Validación extra por seguridad
        if (string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente))
        {
            _mensajeErrorArticulo = "Debes escribir el nombre del cliente primero.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_articuloTemporal.Nombre) || _articuloTemporal.Cantidad <= 0)
        {
            _mensajeErrorArticulo = "Nombre requerido y Cantidad debe ser mayor a 0.";
            return;
        }
        
        ControladorFactura.FacturaEnProgreso.Articulos.Add(_articuloTemporal);
        _articuloTemporal = new ArticuloFactura(); 
        _modoEdicion = false;
    }

    private void IniciarEdicionLocal(ArticuloFactura art)
    {
        _articuloParaEditar = art;
        _articuloTemporal = new ArticuloFactura
        {
            ArticuloId = art.ArticuloId,
            Nombre = art.Nombre,
            Cantidad = art.Cantidad,
            PrecioUnitario = art.PrecioUnitario
        };
        _modoEdicion = true;
    }

    private void ActualizarArticuloLocal()
    {
        _articuloParaEditar.Nombre = _articuloTemporal.Nombre;
        _articuloParaEditar.Cantidad = _articuloTemporal.Cantidad;
        _articuloParaEditar.PrecioUnitario = _articuloTemporal.PrecioUnitario;
        CancelarEdicion();
    }

    private void EliminarArticuloLocal(ArticuloFactura art)
    {
        if (art != null)
        {
            ControladorFactura.FacturaEnProgreso.Articulos.Remove(art);
        }
    }

    private void CancelarEdicion()
    {
        _articuloTemporal = new ArticuloFactura();
        _articuloParaEditar = null;
        _modoEdicion = false;
        _mensajeErrorArticulo = string.Empty;
    }

    private async Task GuardarFacturaAsync()
    {
        if (string.IsNullOrWhiteSpace(ControladorFactura.FacturaEnProgreso.NombreCliente))
        {
            _mensajeErrorArticulo = "El Nombre del Cliente es obligatorio.";
            return;
        }

        if (!ControladorFactura.FacturaEnProgreso.Articulos.Any())
        {
            _mensajeErrorArticulo = "La factura debe tener al menos un artículo.";
            return;
        }
        
        // Usamos ServicioFactura para guardar la venta
        await ServicioFactura.GuardarFacturaAsync(ControladorFactura.FacturaEnProgreso);
        
        // Mensaje de éxito (Opcional: Podrías usar JS alert)
        await JSRuntime.InvokeVoidAsync("alert", "¡Factura guardada exitosamente!");

        // Resetear
        ControladorFactura.FacturaEnProgreso = new Factura();
        _articuloTemporal = new ArticuloFactura();
        _mensajeErrorArticulo = string.Empty;
    }
}
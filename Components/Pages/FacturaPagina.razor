@page "/factura"
@rendermode InteractiveServer


@inject ServicioFactura ServicioFactura
@inject NavigationManager Navigation

<main class="container">
    <h3>Crear Nueva Factura</h3>

    <EditForm Model="_factura" OnValidSubmit="GuardarFactura" FormName="FacturaForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Nombre del Cliente:</label>
            <InputText class="form-control" @bind-Value="_factura.NombreCliente" />
        </div>

       
 <div class="mb-3">
            <label class="form-label">Fecha de la Factura:</label>
            <InputDate class="form-control" @bind-Value="_factura.Fecha" />
        </div>

        <hr />
        <h4>Agregar Artículos</h4>

        <div class="row g-3">
            <div class="col-md-5">
                <label>Nombre del Artículo:</label>
                <InputText class="form-control" @bind-Value="_nuevoArticulo.Nombre" />
            </div>
            <div class="col-md-2">
                <label>Cantidad:</label>
    <InputNumber class="form-control" @bind-Value="_nuevoArticulo.Cantidad" />
            </div>
          
  <div class="col-md-3">
                <label>Precio Unitario:</label>
                <InputNumber class="form-control" @bind-Value="_nuevoArticulo.PrecioUnitario" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
          
      <button type="button" class="btn btn-secondary w-100" @onclick="AgregarArticulo">Agregar</button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_mensajeErrorArticulo))
        {
            <div class="row">
                <div class="col-12">
                    <p class="text-danger mt-2">@_mensajeErrorArticulo</p>
                </div>
            </div>
        }

        <hr />
        <h4>Artículos en la Factura</h4>
        @if (_factura.Articulos.Any())
        {
            <table class="table">
                <thead>
        <tr>
                        <th>ID Artículo</th>
                        <th>Nombre</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var art in _factura.Articulos)
            {
                        <tr>
                            <td>@art.ArticuloId.ToString().Substring(0, 8)</td>
                            <td>@art.Nombre</td>
                            <td>@art.Cantidad</td>
                    <td>@art.PrecioUnitario.ToString("C")</td>
                            <td>@art.Total.ToString("C")</td>
           </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>Aún no hay artículos agregados.</p>
   }

        <div class="text-end">
            <h3>Total: @_factura.Total.ToString("C")</h3>
        </div>

    </EditForm>
</main>



@code {
    private Factura _factura = new Factura();
private ArticuloFactura _nuevoArticulo = new ArticuloFactura();
    
    private string _mensajeErrorArticulo = string.Empty;

    private void AgregarArticulo()
    {

        if (string.IsNullOrWhiteSpace(_nuevoArticulo.Nombre))
        {
            _mensajeErrorArticulo = "Por favor, ingrese un nombre para el artículo.";
        }
        else if (_nuevoArticulo.Cantidad <= 0)
        {
            _mensajeErrorArticulo = "La cantidad debe ser al menos 1.";
        }
        else if (_nuevoArticulo.PrecioUnitario < 0)
        {
            _mensajeErrorArticulo = "El precio unitario no puede ser negativo.";
        }
        else
        {

            _mensajeErrorArticulo = string.Empty; 
            _factura.Articulos.Add(_nuevoArticulo);
   _nuevoArticulo = new ArticuloFactura();
        }
    }

    private void GuardarFactura()
    {
        ServicioFactura.AgregarFactura(_factura);
_factura = new Factura();
        _nuevoArticulo = new ArticuloFactura();
        _mensajeErrorArticulo = string.Empty;
    }
}
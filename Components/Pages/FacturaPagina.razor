@page "/factura"
@rendermode InteractiveServer

@inject ServicioFactura ServicioFactura
@inject ServicioEstadoUsuario EstadoUsuario

<main class="container">
    <h3>Facturación</h3>

    <div class="mb-3">
        <label class="form-label">Nombre del Cliente:</label>
        <InputText class="form-control" @bind-Value="_nombreCliente" placeholder="Escriba un nombre para ver o agregar artículos..." />
        <button class="btn btn-info mt-2" @onclick="CargarArticulos">Cargar Artículos</button>
    </div>

    <hr />

    <h4>@(_modoEdicion ? "Editando Artículo" : "Agregar Artículos")</h4>

    <EditForm Model="_nuevoArticulo" OnValidSubmit="GuardarArticulo" FormName="ArticuloForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row g-3">
            <div class="col-md-5">
                <label>Nombre del Artículo:</label>
                <InputText class="form-control" @bind-Value="_nuevoArticulo.Nombre" />
            </div>
            <div class="col-md-2">
                <label>Cantidad:</label>
                <InputNumber class="form-control" @bind-Value="_nuevoArticulo.Cantidad" />
            </div>
            <div class="col-md-3">
                <label>Precio Unitario:</label>
                <InputNumber class="form-control" @bind-Value="_nuevoArticulo.PrecioUnitario" />
            </div>
            
            <div class="col-md-2 d-flex flex-column align-items-end justify-content-end">
                @if (_modoEdicion)
                {
                    <button type="submit" class="btn btn-warning w-100">Actualizar</button>
                    <button type="button" class="btn btn-secondary w-100 mt-1" @onclick="CancelarEdicion">Cancelar</button>
                }
                else
                {
                    <button type="submit" class="btn btn-primary w-100">Agregar</button>
                }
            </div>
        </div>
        @if (!string.IsNullOrEmpty(_mensajeErrorArticulo))
        {
            <p class="text-danger mt-2">@_mensajeErrorArticulo</p>
        }
    </EditForm>
    
    <hr />

    <h4>Artículos de: @_nombreCliente</h4>
    @if (_articulosMostrados.Any())
    {
        <table class="table table-striped"> <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th>Editar</th> <th>Eliminar</th> </tr>
            </thead>
            <tbody>
                @foreach (var art in _articulosMostrados)
                {
                    <tr>
                        <td>@art.Nombre</td>
                        <td>@art.Cantidad</td>
                        <td>@art.PrecioUnitario.ToString("C")</td>
                        <td>@art.Total.ToString("C")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning" @onclick="() => IniciarEdicion(art)">
                                Editar
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => IniciarEliminacion(art.ArticuloId)">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        
        <div class="text-end">
            <h3>Total: @_articulosMostrados.Sum(a => a.Total).ToString("C")</h3>
        </div>
    }
    else
    {
        <p>No hay artículos para este cliente. ¡Agrega uno!</p>
    }
</main>

@code {
   private string _nombreCliente = string.Empty;
    private ArticuloFactura _nuevoArticulo = new ArticuloFactura();
    private List<ArticuloFactura> _articulosMostrados = new List<ArticuloFactura>();
    private string _mensajeErrorArticulo = string.Empty;
    
    private bool _modoEdicion = false;

    protected override async Task OnInitializedAsync()
    {
        _nombreCliente = EstadoUsuario.NombreClienteActual;
        if (!string.IsNullOrWhiteSpace(_nombreCliente))
        {
            await CargarArticulos();
        }
    }

    // carga la tabla
    private async Task CargarArticulos()
    {
        EstadoUsuario.NombreClienteActual = _nombreCliente;
        _articulosMostrados = await ServicioFactura.GetArticulosPorClienteAsync(_nombreCliente);
    }

    // agrega o actualiza un articulo
    private async Task GuardarArticulo()
    {
        _mensajeErrorArticulo = string.Empty;

        // valida el articulo

        if (string.IsNullOrWhiteSpace(_nombreCliente)) {
            _mensajeErrorArticulo = "Debe ingresar un Nombre de Cliente primero."; return; }
        if (string.IsNullOrWhiteSpace(_nuevoArticulo.Nombre)) {
            _mensajeErrorArticulo = "Por favor, ingrese un nombre para el artículo."; return; }
        if (_nuevoArticulo.Cantidad <= 0) {
            _mensajeErrorArticulo = "La cantidad debe ser al menos 1."; return; }
        if (_nuevoArticulo.PrecioUnitario < 0) {
            _mensajeErrorArticulo = "El precio unitario no puede ser negativo."; return; }

        if (_modoEdicion)
        {
            // actualiza
            await ServicioFactura.ActualizarArticuloAsync(_nuevoArticulo);
        }
        else
        {
            // agrega
            _nuevoArticulo.NombreCliente = _nombreCliente;
            await ServicioFactura.AgregarArticuloAsync(_nuevoArticulo);
        }

        CancelarEdicion(); 
        await CargarArticulos();
    }

    // carga el articulo en el modo de edicion
    private void IniciarEdicion(ArticuloFactura articuloAEditar)
    {
        _nuevoArticulo = new ArticuloFactura
        {
            ArticuloId = articuloAEditar.ArticuloId,
            NombreCliente = articuloAEditar.NombreCliente,
            Nombre = articuloAEditar.Nombre,
            Cantidad = articuloAEditar.Cantidad,
            PrecioUnitario = articuloAEditar.PrecioUnitario
        };
        
        _modoEdicion = true;
        _mensajeErrorArticulo = string.Empty;
    }

    //cancela el modo edicion
    private void CancelarEdicion()
    {
        _nuevoArticulo = new ArticuloFactura();
        _modoEdicion = false;
        _mensajeErrorArticulo = string.Empty;
    }

    // elimina un articulo
    private async Task IniciarEliminacion(Guid articuloId)
    {
        await ServicioFactura.EliminarArticuloAsync(articuloId);
        await CargarArticulos(); 
    }
}